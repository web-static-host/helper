<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Помощник технаря</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="config.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        .search-box { margin-bottom: 10px; }
        input[type="text"] { width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; }
        
        .sfr-option { margin-bottom: 20px; font-size: 14px; color: #555; display: flex; align-items: center; gap: 8px; }
        
        .result-table { width: 100%; border-collapse: collapse; display: none; margin-top: 10px; }
        .result-table td { padding: 12px; border: 1px solid #ddd; font-size: 14px; }
        .result-table td:first-child { background: #f8f9fa; font-weight: bold; width: 35%; color: #555; }

        /* МОДАЛЬНОЕ ОКНО (DIALOG) */
        dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            padding: 0;
            width: 500px;
            overflow: hidden;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.6);
        }
        .modal-header {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header span { cursor: pointer; font-size: 20px; }
        
        iframe {
            width: 100%;
            height: 550px;
            border: none;
        }

        .error { color: red; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Помощник технаря</h2>

    <div class="search-box">
        <input type="text" id="innInput" placeholder="Введите ИНН">
        <button onclick="getData()">Найти</button>
    </div>

    <div class="sfr-option">
        <input type="checkbox" id="sfrCheck">
        <label for="sfrCheck">Запросить СФР (в модальном окне)</label>
    </div>

    <div id="errorBox" class="error"></div>

    <table class="result-table" id="resTable">
        <tbody id="resBody"></tbody>
    </table>
</div>

<dialog id="sfrDialog">
    <div class="modal-header">
        <strong>Проверка СФР (введите капчу там)</strong>
        <span onclick="document.getElementById('sfrDialog').close()">×</span>
    </div>
    <iframe id="sfrIframe" src=""></iframe>
</dialog>

<script>
    async function getData() {
        const inn = document.getElementById('innInput').value.trim();
        const errorBox = document.getElementById('errorBox');
        const table = document.getElementById('resTable');
        const body = document.getElementById('resBody');
        const sfrCheck = document.getElementById('sfrCheck');
        const dialog = document.getElementById('sfrDialog');
        const iframe = document.getElementById('sfrIframe');
        
        errorBox.innerText = "";
        table.style.display = "none";
        body.innerHTML = "";

        if (!inn) { errorBox.innerText = "Введите ИНН"; return; }
        if (typeof API_KEY === 'undefined') { errorBox.innerText = "Ошибка: config.js не найден."; return; }

        try {
            const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/party", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                    "Authorization": "Token " + API_KEY
                },
                body: JSON.stringify({query: inn})
            });

            const result = await response.json();

            if (result.suggestions && result.suggestions.length > 0) {
                const d = result.suggestions[0].data;
                const s = result.suggestions[0];

                // Если СФР включен - открываем ДИАЛОГОВОЕ ОКНО поверх страницы
                if (sfrCheck.checked) {
                    const kppParam = d.kpp ? `&kpp=${d.kpp}` : "";
                    iframe.src = `https://ecp.sfr.gov.ru/new-reg-num?inn=${d.inn}${kppParam}`;
                    dialog.showModal(); // Открывает как модальное окно
                }

                // ... (Логика заполнения таблицы такая же, как раньше)
                let okvedFull = d.okved_details?.name ? d.okved_details.name + " (" + d.okved + ")" : (d.okved || "—");
                const addressStr = (d.address?.data?.postal_code ? d.address.data.postal_code + ", " : "") + (d.address?.value || "—");

                const fields = [
                    ["ИНН", d.inn || "—"],
                    ["КПП", d.kpp || "—"],
                    ["Наименование", d.name?.short_with_opf || s.value],
                    ["Адрес", addressStr],
                    ["Деятельность", okvedFull],
                    ["Код СФР (из базы)", d.sfr_registration_number || "—"]
                ];

                body.innerHTML = fields.map(f => `<tr><td>${f[0]}</td><td>${f[1]}</td></tr>`).join("");
                table.style.display = "table";
            } else {
                errorBox.innerText = "Организация не найдена.";
            }
        } catch (e) {
            errorBox.innerText = "Ошибка получения данных.";
        }
    }
</script>
</body>
</html>