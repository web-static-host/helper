<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–º–æ—â–Ω–∏–∫ —Ç–µ—Ö–Ω–∞—Ä—è</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="config.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        
        .main-wrapper { 
            display: flex; 
            gap: 20px; 
            max-width: 1200px; 
            margin: auto; 
            align-items: flex-start;
        }

        .left-panel { 
            flex: 2; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .right-panel { 
            flex: 1; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 20px; 
        }

        h2 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 18px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button.primary-btn { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button.primary-btn:hover { background: #0056b3; }

        .result-table { width: 100%; border-collapse: collapse; display: none; margin-top: 10px; }
        .result-table td { padding: 12px; border: 1px solid #ddd; font-size: 14px; }
        .result-table td:first-child { background: #f8f9fa; font-weight: bold; width: 35%; color: #555; }
        
        .error { color: red; margin-top: 10px; font-weight: bold; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .tool-section { margin-bottom: 15px; }
        .tool-section summary { 
            font-weight: bold; 
            cursor: pointer; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            list-style: none;
            display: flex;
            justify-content: space-between;
        }
        .tool-section summary::-webkit-details-marker { display: none; }
        .tool-section summary::after { content: '‚ñº'; font-size: 10px; color: #888; }
        .tool-section[open] summary::after { content: '‚ñ≤'; }

        .links-list { list-style: none; padding: 5px 0 0 0; margin: 0; }
        .link-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            border-bottom: 1px solid #f0f0f0; 
        }
        .link-item:last-child { border-bottom: none; }
        
        .link-info { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
        .link-name { color: #333; font-weight: 500; font-size: 14px; }
        .link-url { color: #888; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

        .copy-link-btn { 
            background: #eee; border: 1px solid #ccc; border-radius: 4px; padding: 4px 8px; 
            cursor: pointer; font-size: 12px; transition: 0.2s; flex-shrink: 0;
        }
        .copy-link-btn:hover { background: #ddd; }

        .raw-data-container { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 300px; }
        summary.json-sum { cursor: pointer; color: #888; font-size: 13px; margin-bottom: 10px; outline: none; }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="left-panel">
        <h2>–ü–æ–º–æ—â–Ω–∏–∫ —Ç–µ—Ö–Ω–∞—Ä—è</h2>
        <div class="search-box">
            <input type="text" id="innInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –ò–ü">
            <button class="primary-btn" onclick="getData()">–ù–∞–π—Ç–∏</button>
        </div>
        <div id="errorBox" class="error"></div>
        <table class="result-table" id="resTable">
            <tbody id="resBody"></tbody>
        </table>
        <div id="rawContainer" class="raw-data-container" style="display:none;">
            <details>
                <summary class="json-sum">–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</summary>
                <pre id="rawData"></pre>
            </details>
        </div>
    </div>

    <div class="right-panel">
        <h3>–î–æ–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        
        <details class="tool-section" open>
            <summary>–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Å—ã–ª–∫–∏</summary>
            <div id="linksContainer" class="links-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </details>

        <details class="tool-section">
            <summary>–ë—É–¥—É—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</summary>
            <div style="padding: 10px; font-size: 12px; color: #888;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —á—Ç–æ-—Ç–æ –µ—â–µ...</div>
        </details>
    </div>

</div>

<script>
    async function initLinks() {
        const container = document.getElementById('linksContainer');
        if (typeof GOOGLE_SHEET_CSV_URL === 'undefined' || !GOOGLE_SHEET_CSV_URL) {
            container.innerHTML = "<span style='color:orange; font-size:12px;'>–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ config.js</span>";
            return;
        }
        
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status);
            
            const data = await response.text();
            const rows = data.split(/\r?\n/).slice(1); 
            
            container.innerHTML = rows.map(row => {
                if (!row.trim()) return '';
                const columns = row.split(/[,;](?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (columns.length < 2) return '';
                
                const name = columns[0].replace(/"/g, '').trim();
                const url = columns[1].replace(/"/g, '').trim();
                
                if(!name || !url) return '';
                
                return `
                    <div class="link-item">
                        <div class="link-info">
                            <span class="link-name">${name}</span>
                            <span class="link-url">${url}</span>
                        </div>
                        <button class="copy-link-btn" onclick="copyToClipboard('${url}', this)">üìã</button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            container.innerHTML = "<span style='color:red; font-size:12px;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</span>";
            console.error("–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:", e);
        }
    }

    function copyToClipboard(text, btn) {
        navigator.clipboard.writeText(text).then(() => {
            const oldText = btn.innerText;
            btn.innerText = "‚úÖ";
            setTimeout(() => btn.innerText = oldText, 1000);
        });
    }

    async function getData() {
        const inn = document.getElementById('innInput').value.trim();
        const errorBox = document.getElementById('errorBox');
        const table = document.getElementById('resTable');
        const body = document.getElementById('resBody');
        const rawContainer = document.getElementById('rawContainer');
        const rawPre = document.getElementById('rawData');
        
        errorBox.innerText = "";
        table.style.display = "none";
        rawContainer.style.display = "none";
        body.innerHTML = "";

        if (!inn) { errorBox.innerText = "–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù"; return; }
        if (typeof API_KEY === 'undefined') { errorBox.innerText = "–û—à–∏–±–∫–∞: config.js –Ω–µ –Ω–∞–π–¥–µ–Ω."; return; }

        try {
            const response = await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/party", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                    "Authorization": "Token " + API_KEY
                },
                body: JSON.stringify({query: inn})
            });

            const result = await response.json();

            if (result.suggestions && result.suggestions.length > 0) {
                const d = result.suggestions[0].data;
                const s = result.suggestions[0];

                rawPre.innerText = JSON.stringify(result, null, 2);
                rawContainer.style.display = "block";

                let okvedFull = "‚Äî";
                if (d.okved_details && d.okved_details.name) {
                    okvedFull = d.okved + " (" + d.okved_details.name + ")";
                } else if (d.okved) { okvedFull = d.okved; }

                const index = (d.address && d.address.data && d.address.data.postal_code) ? d.address.data.postal_code + ", " : "";
                const addressStr = index + (d.address ? d.address.value : "‚Äî");

                const fields = [
                    ["–ò–ù–ù", d.inn || "‚Äî"],
                    ["–ö–ü–ü", d.kpp || "‚Äî"],
                    ["–û–ì–†–ù / –û–ì–†–ù–ò–ü", d.ogrn || "‚Äî"],
                    ["–û–ö–ü–û", d.okpo || "‚Äî"],
                    ["–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", d.name?.full_with_opf || s.value],
                    ["–°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", d.name?.short_with_opf || s.value],
                    ["–Æ—Ä. –∞–¥—Ä–µ—Å", addressStr],
                    ["–û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", okvedFull],
                    ["–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", d.management?.name || (d.type === "INDIVIDUAL" ? s.value : "‚Äî")],
                    ["–ò–§–ù–° —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è", d.tax_authority?.name || "‚Äî"],
                    ["–ò–§–ù–° —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—â–∞—è", d.registration_authority?.name || "‚Äî"],
                    ["–ö–æ–¥ –°–§–† (–Ω–æ–≤—ã–π)", d.sfr_registration_number || "‚Äî"]
                ];

                body.innerHTML = fields.map(f => `<tr><td>${f[0]}</td><td>${f[1]}</td></tr>`).join("");
                table.style.display = "table";
            } else {
                errorBox.innerText = "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
            }
        } catch (e) {
            errorBox.innerText = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.";
            console.error(e);
        }
    }

    initLinks();
</script>

</body>
</html>